name: Check RSS Feeds

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š 10 ç‚¹ (åŒ—äº¬æ—¶é—´ UTC+8ï¼Œå³ UTC 2 ç‚¹) è¿è¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-feeds:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Check RSS feeds
        run: node scripts/check-feeds.js

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: feed-check-results
          path: feed-status.json
        if: always()

      - name: Update README badge
        run: |
          if [ -f feed-status.json ]; then
            TOTAL=$(jq '.total' feed-status.json)
            VALID=$(jq '.valid' feed-status.json)
            echo "æ£€æµ‹å®Œæˆ: $VALID/$TOTAL ä¸ªé“¾æ¥å¯ç”¨"
          fi

      - name: Create Issue if feeds are broken
        uses: actions/github-script@v7
        if: failure()
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('feed-status.json')) {
              const status = JSON.parse(fs.readFileSync('feed-status.json', 'utf8'));
              const broken = status.feeds.filter(f => !f.valid);
              if (broken.length > 0) {
                const body = `## âš ï¸ RSS é“¾æ¥æ£€æµ‹æŠ¥å‘Š\n\næ£€æµ‹æ—¶é—´: ${new Date().toISOString()}\n\n### å¤±æ•ˆé“¾æ¥ (${broken.length} ä¸ª)\n\n${broken.map(f => `- [ ] **${f.name}**: \`${f.url}\` - ${f.error}`).join('\n')}`;
                github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ğŸ”´ å‘ç° ${broken.length} ä¸ªå¤±æ•ˆçš„ RSS é“¾æ¥`,
                  body: body,
                  labels: ['bug', 'feed-check']
                });
              }
            }
